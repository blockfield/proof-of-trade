"use strict";(self.webpackChunkproof_of_trade_client=self.webpackChunkproof_of_trade_client||[]).push([[592],{8031:(b,p,a)=>{a.d(p,{$:()=>A});var h=a(4762),y=a(9412);class S{constructor(n,t,e,r,s,c,l){this.type=n,this.value=t,this.salt=e,this.previousBalance=r,this.previousBalanceHash=s,this.hash=c,this.price=l}}class w{constructor(n,t,e,r,s,c){this.balanceHash=n,this.balance=t,this.previousBalanceHash=e,this.hashes=r,this.prices=s,this.price_now=c}toArray(){let n=[this.balanceHash,this.balance,this.previousBalanceHash];return n.push(...this.hashes,...this.prices,this.price_now),n}}var o=a(7716),g=a(6044),P=a(9358);let B=(()=>{class i{constructor(){}prove(t){return(0,h.mG)(this,void 0,void 0,function*(){return window.witness(t)})}verify(t,e,r){return(0,h.mG)(this,void 0,void 0,function*(){return window.groth16Verify(t,e.toArray(),r)})}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=o.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();var V=a(6215);let m=(()=>{class i{constructor(){this.verificationKey=new V.X(null),this.initAssets()}initAssets(){fetch("./assets/verification_key.json").then(t=>t.json()).then(t=>{this.verificationKey.next(t)})}getVerificationKey(){if(!this.verificationKey.getValue())throw new Error("Verfiication key not loaded yet");return this.verificationKey.getValue()}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=o.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),A=(()=>{class i{constructor(t,e,r,s,c){this.contract=t,this.priceService=e,this.walletService=r,this.witnessService=s,this.assetsService=c}prove(t){return(0,y.D)(this.internalProve(t))}internalProve(t){return(0,h.mG)(this,void 0,void 0,function*(){const e=this.walletService.getAddress(),r=yield this.contract.getTradeLen(),s=yield this.contract.getSignal(e,r-2),c=yield this.contract.getSignal(e,r-1),l=t.proofs[0].price/1e9,d=t.proofs[1].price/1e9,u=this.priceService.getBtcPrice(),v=yield this.contract.getProofLen(e);let f="16865888626473709837690039826672233841362137295365548295255658602462103516806";0!==v&&(f=yield this.contract.getPrevBalanceHash(e,v-1));let G=new S([t.proofs[0].action,t.proofs[1].action],[t.proofs[0].amount,t.proofs[1].amount],[t.proofs[0].nonce,t.proofs[1].nonce],[Math.round(t.usdBalance),Math.round(t.btcBalance)],f,[s.hash,c.hash],[Math.round(l),Math.round(d),Math.round(u)]);const H=yield this.witnessService.prove(G);yield this.contract.addPeriodProof(H,[1e9*u])})}verify(t,e){return(0,y.D)(this.internalVerify(t,e))}verifyAll(t,e){return(0,y.D)(this.internalVerifyAll(t,e))}internalVerifyAll(t,e){return(0,h.mG)(this,void 0,void 0,function*(){let r=!0;for(const s of e){let c=yield this.internalVerify(t,s);r=r&&c}return new Promise(s=>{s(r)})})}internalVerify(t,e){return(0,h.mG)(this,void 0,void 0,function*(){const r=yield this.contract.getPeriodProofs(t,e),s=yield this.contract.getSignal(t,2*e),c=yield this.contract.getSignal(t,2*e+1),l=Math.round(s.price/1e9),d=Math.round(c.price/1e9),u=Math.round(r.prices[0]/1e9);let v="16865888626473709837690039826672233841362137295365548295255658602462103516806";0!==e&&(v=(yield this.contract.getPeriodProofs(t,e-1)).newBalanceHash);const f=new w(r.newBalanceHash,r.y,v,[s.hash,c.hash],[l,d],u);return this.witnessService.verify(this.assetsService.getVerificationKey(),f,r.proof)})}}return i.\u0275fac=function(t){return new(t||i)(o.LFG("SmartContractInterface"),o.LFG(g.N),o.LFG(P.X),o.LFG(B),o.LFG(m))},i.\u0275prov=o.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})()}}]);