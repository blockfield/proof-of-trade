"use strict";(self.webpackChunkproof_of_trade_client=self.webpackChunkproof_of_trade_client||[]).push([[592],{1642:(B,m,o)=>{o.d(m,{k:()=>l});var h=o(7716),u=o(9344);let l=(()=>{class v{constructor(s){this.toastr=s}success(s,f=null){this.toastr.clear(),this.toastr.success(s,f,{positionClass:"toast-bottom-right"})}error(s,f=null){this.toastr.clear(),this.toastr.error(s,f,{positionClass:"toast-bottom-right"})}}return v.\u0275fac=function(s){return new(s||v)(h.LFG(u._W))},v.\u0275prov=h.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"}),v})()},8031:(B,m,o)=>{o.d(m,{$:()=>Z});var h=o(4762),u=o(9412),l=o(3384);class v{constructor(c,t,e,r,n,a,y){this.type=c,this.value=t,this.salt=e,this.previousBalance=r,this.previousBalanceHash=n,this.hash=a,this.price=y}}class S{constructor(c,t,e,r,n,a){this.balanceHash=c,this.balance=t,this.previousBalanceHash=e,this.hashes=r,this.prices=n,this.price_now=a}toArray(){let c=[this.balanceHash,this.balance,this.previousBalanceHash];return c.push(...this.hashes,...this.prices,this.price_now),c}}var s=o(7716),f=o(6044),V=o(9358);let A=(()=>{class i{constructor(){}prove(t){return(0,h.mG)(this,void 0,void 0,function*(){return window.witness(t)})}verify(t,e,r){return(0,h.mG)(this,void 0,void 0,function*(){return window.groth16Verify(t,e.toArray(),r)})}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=s.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();var D=o(6215);let F=(()=>{class i{constructor(){this.verificationKey=new D.X(null),this.initAssets()}initAssets(){fetch("./assets/verification_key.json").then(t=>t.json()).then(t=>{this.verificationKey.next(t)})}getVerificationKey(){if(!this.verificationKey.getValue())throw new Error("Verfiication key not loaded yet");return this.verificationKey.getValue()}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=s.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),Z=(()=>{class i{constructor(t,e,r,n,a){this.contract=t,this.priceService=e,this.walletService=r,this.witnessService=n,this.assetsService=a}prove(t){return(0,u.D)(this.internalProve(t))}internalProve(t){return(0,h.mG)(this,void 0,void 0,function*(){const e=this.walletService.getAddress(),r=yield this.contract.getTradeLen(),n=yield this.contract.getSignal(e,r-2),a=yield this.contract.getSignal(e,r-1),y=l.Z.floorNumber(t.proofs[0].price),w=l.Z.floorNumber(t.proofs[1].price),g=l.Z.removeDecimalDigitsNumber(this.priceService.getBtcPriceValue()),p=yield this.contract.getProofLen(e);let d="639470893622803446635721399483204517617715645899470263648676575355455357367";0!==p&&(d=yield this.contract.getPrevBalanceHash(e,p-1));let b=new v([t.proofs[0].action,t.proofs[1].action],[t.proofs[0].amount,t.proofs[1].amount],[t.proofs[0].nonce,t.proofs[1].nonce],[t.usdBalance,t.btcBalance],d,[n.hash,a.hash],[l.Z.removeDecimalDigitsNumber(y),l.Z.removeDecimalDigitsNumber(w),g]);console.log("input",b);const P=yield this.witnessService.prove(b);console.log("input",P),yield this.contract.addPeriodProof(P,[l.Z.numberToBigInt(g)])})}verify(t,e){return(0,u.D)(this.internalVerify(t,e))}verifyAll(t,e){return(0,u.D)(this.internalVerifyAll(t,e))}internalVerifyAll(t,e){return(0,h.mG)(this,void 0,void 0,function*(){let r=!0;for(const n of e){let a=yield this.internalVerify(t,n);r=r&&a}return new Promise(n=>{n(r)})})}internalVerify(t,e){return(0,h.mG)(this,void 0,void 0,function*(){const r=yield this.contract.getPeriodProofs(t,e),n=yield this.contract.getSignal(t,2*e),a=yield this.contract.getSignal(t,2*e+1),y=l.Z.bigIntToFloorNumber(n.price),w=l.Z.bigIntToFloorNumber(a.price),g=l.Z.bigIntToFloorNumber(r.prices[0]);let p="639470893622803446635721399483204517617715645899470263648676575355455357367";0!==e&&(p=(yield this.contract.getPeriodProofs(t,e-1)).newBalanceHash);const d=new S(r.newBalanceHash,r.y,p,[n.hash,a.hash],[y,w],g);return console.log("witness",d),this.witnessService.verify(this.assetsService.getVerificationKey(),d,r.proof)})}}return i.\u0275fac=function(t){return new(t||i)(s.LFG("SmartContractInterface"),s.LFG(f.N),s.LFG(V.X),s.LFG(A),s.LFG(F))},i.\u0275prov=s.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})()}}]);