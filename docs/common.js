"use strict";(self.webpackChunkproof_of_trade_client=self.webpackChunkproof_of_trade_client||[]).push([[592],{4612:(S,f,n)=>{n.d(f,{Z:()=>h});let h=(()=>{class l{}return l.initialBalance=1e5,l.nanoBtc=1e9,l})()},3384:(S,f,n)=>{n.d(f,{Z:()=>l});var h=n(4612);class l{static numberToBigInt(v){return BigInt(v)*BigInt(h.Z.nanoBtc)}static bigIntToFloorNumber(v){return this.floorNumber(Number(v/BigInt(h.Z.nanoBtc)))}static floorNumber(v){return Math.floor(v)}}},8031:(S,f,n)=>{n.d(f,{$:()=>V});var h=n(4762),l=n(9412),a=n(3384);class v{constructor(o,t,e,i,s,c,d){this.type=o,this.value=t,this.salt=e,this.previousBalance=i,this.previousBalanceHash=s,this.hash=c,this.price=d}}class b{constructor(o,t,e,i,s,c){this.balanceHash=o,this.balance=t,this.previousBalanceHash=e,this.hashes=i,this.prices=s,this.price_now=c}toArray(){let o=[this.balanceHash,this.balance,this.previousBalanceHash];return o.push(...this.hashes,...this.prices,this.price_now),o}}var u=n(7716),w=n(6044),B=n(9358);let P=(()=>{class r{constructor(){}prove(t){return(0,h.mG)(this,void 0,void 0,function*(){return window.witness(t)})}verify(t,e,i){return(0,h.mG)(this,void 0,void 0,function*(){return window.groth16Verify(t,e.toArray(),i)})}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=u.Yz7({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();var Z=n(6215);let N=(()=>{class r{constructor(){this.verificationKey=new Z.X(null),this.initAssets()}initAssets(){fetch("./assets/verification_key.json").then(t=>t.json()).then(t=>{this.verificationKey.next(t)})}getVerificationKey(){if(!this.verificationKey.getValue())throw new Error("Verfiication key not loaded yet");return this.verificationKey.getValue()}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=u.Yz7({token:r,factory:r.\u0275fac,providedIn:"root"}),r})(),V=(()=>{class r{constructor(t,e,i,s,c){this.contract=t,this.priceService=e,this.walletService=i,this.witnessService=s,this.assetsService=c}prove(t){return(0,l.D)(this.internalProve(t))}internalProve(t){return(0,h.mG)(this,void 0,void 0,function*(){const e=this.walletService.getAddress(),i=yield this.contract.getTradeLen(),s=yield this.contract.getSignal(e,i-2),c=yield this.contract.getSignal(e,i-1),d=a.Z.floorNumber(t.proofs[0].price),m=a.Z.floorNumber(t.proofs[1].price),p=a.Z.floorNumber(this.priceService.getBtcPrice()),y=yield this.contract.getProofLen(e);let g="16865888626473709837690039826672233841362137295365548295255658602462103516806";0!==y&&(g=yield this.contract.getPrevBalanceHash(e,y-1));let A=new v([t.proofs[0].action,t.proofs[1].action],[t.proofs[0].amount,t.proofs[1].amount],[t.proofs[0].nonce,t.proofs[1].nonce],[a.Z.floorNumber(t.usdBalance),a.Z.floorNumber(t.btcBalance)],g,[s.hash,c.hash],[d,m,p]);const F=yield this.witnessService.prove(A);yield this.contract.addPeriodProof(F,[a.Z.numberToBigInt(p)])})}verify(t,e){return(0,l.D)(this.internalVerify(t,e))}verifyAll(t,e){return(0,l.D)(this.internalVerifyAll(t,e))}internalVerifyAll(t,e){return(0,h.mG)(this,void 0,void 0,function*(){let i=!0;for(const s of e){let c=yield this.internalVerify(t,s);i=i&&c}return new Promise(s=>{s(i)})})}internalVerify(t,e){return(0,h.mG)(this,void 0,void 0,function*(){const i=yield this.contract.getPeriodProofs(t,e),s=yield this.contract.getSignal(t,2*e),c=yield this.contract.getSignal(t,2*e+1),d=a.Z.bigIntToFloorNumber(s.price),m=a.Z.bigIntToFloorNumber(c.price),p=a.Z.bigIntToFloorNumber(i.prices[0]);let y="16865888626473709837690039826672233841362137295365548295255658602462103516806";0!==e&&(y=(yield this.contract.getPeriodProofs(t,e-1)).newBalanceHash);const g=new b(i.newBalanceHash,i.y,y,[s.hash,c.hash],[d,m],p);return this.witnessService.verify(this.assetsService.getVerificationKey(),g,i.proof)})}}return r.\u0275fac=function(t){return new(t||r)(u.LFG("SmartContractInterface"),u.LFG(w.N),u.LFG(B.X),u.LFG(P),u.LFG(N))},r.\u0275prov=u.Yz7({token:r,factory:r.\u0275fac,providedIn:"root"}),r})()}}]);